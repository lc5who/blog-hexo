---
title: 分布式缓存之一
date: 2022-03-06 01:27:05
tags: 分布式缓存
---
### 缓存的读写模式
1. 旁路缓存(Cache Aside)
    * write：更新db，删除cache，db驱动cache更新
    * read：miss后从db读取
    * 适合场景:更强一致性，cache数据构建复杂
2. 读写穿透(Read/Write Through)
    * write:cache不存在更新db,cache存在更新cache+db
    * read:miss后由缓存服务加载并写cache
    * 特点：存储服务负责数据读写，隔离型更佳，热数据友好
    * 适合场景：数据由冷热之分
3. 异步缓存写入(Write Behind Caching)
    * write：只更新缓存，缓存服务异步更新db
    * read：miss后由缓存服务加载+写cache
    * 特点：写性能最高，定期异步刷新，存在数据丢失概率
    * 适合场景：写频率超高，需要合并    
### 缓存三大问题
* 缓存失效
> 大量key同时过期，cache访问miss，穿透到db，db压力增大，慢查率增大
#### 1. 预先设置 expire time
#### 2. 主动/被动 批量db加载，写入缓存时，设置预制过期时间
#### 3. 到达过期时间，一起失效
#### 4. 批量请求一起穿透到db
#### 一般解决策略：设置过期时间为base+random
---
* 缓存穿透
> 查询一个不存在的key，每次访问都穿透到db，对db造成压力 
1. 系统访问策略，cache miss后查db
2. 正常的key，会查询到value并返回
3. 不存在的key 没查到value 返回null
4. 不存在的key 后续查询cache miss，走db
> 原因：对特殊访问路径欠缺考虑  如 通过不存在的uid，访问不存在的用户，通过不存在的车次id，访问不存在的车票信息 
#### 一般解决策略：对未查询到值的键依然缓存null或特殊的值||使用布隆过滤器
--- 
* 缓存雪崩
> 部分缓存节点不可用，导致整个缓存体系，服务系统不可用的情况    
1. 缓存不支持rehash导致的系统雪崩不可用
2. 缓存支持rehash导致的系统雪崩不可用
#### 一般解决方案：
- 增加db读写开关，慢查询超过阀值，关闭开关，failfast
- 多副本cache架构，任何cache池miss后，读其他cache副本
- 实时监控，及时发现并恢复，增加自动故障转移策略
--- 
### 缓存数据问题
1. cache数据与db数据不一致
- 更新db后，cache更新失败，cache存的老数据
- 采用rehash策略，在节点多次上下线后，也会产生脏数据
#### 解决方案：
1. cache更新失败后，重试or延迟删除
2. 调短过期时间，db重新加载
3. 拒绝rehash漂移，采用缓存分层策略
--- 
2. 数据并发竞争
> 高并发访问场景，缓存miss，并发到db查相同key
#### 业务场景：
- 某车次缓存信息过期，仍然有大量用户同时查询
#### 解决方案：
1. 缓存miss后，加全局锁，唯一进程查db并回写
2. 其他进程查询，若缓存miss，先查是否倍锁定，发现有锁就等待
3. 等加锁进程回写完毕后，从缓存加载
4. 缓存增加多个备份 

